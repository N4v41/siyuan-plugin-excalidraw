<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="javascript">window.EXCALIDRAW_ASSET_PATH = "/plugins/siyuan-plugin-excalidraw/excalidraw/";</script>
    <script src="/plugins/siyuan-plugin-excalidraw/react.development.js"></script>
    <script src="/plugins/siyuan-plugin-excalidraw/react-dom.development.js"></script>
    <script src="/plugins/siyuan-plugin-excalidraw/excalidraw/excalidraw.development.js"></script>
    <link href="/plugins/siyuan-plugin-excalidraw/style.css" rel="stylesheet">
    <style>
        body,
        .excalidraw-wrapper,
        .excalidraw-component {
            height: 100vh;
            margin: 0;
        }
    </style>
</head>

<body>
    <div class="excalidraw-wrapper">
        <div class="button" onclick="window.location.reload()">Reload...</div>
    </div>
    <script>
        const name = window.frameElement.getAttribute('data-name');
        const id = window.frameElement.getAttribute('data-id');
        let initialized = false;
        window.parent.postMessage({
            type: 'excalidraw-loaded',
            params: {
                name,
                id,
            },
        });
        let initData;
        const d = window.addEventListener('message', (p) => {
            initData = p.data.data;
            init();
        }, false);
        const App = () => {

            const [isFullScreen, setIsFullScreen] = React.useState(false);
            const excalidrawRef = React.useRef(null);

            function toggleFullscreen() {
                const el = document.querySelector('.excalidraw-wrapper');
                if (!el) {
                    return;
                }
                if (!isFullScreen) {
                    el.requestFullscreen && el.requestFullscreen();
                } else {
                    document.exitFullscreen && document.exitFullscreen();
                }

                setIsFullScreen(!isFullScreen);
            }

            let timer;

            function debounce(fn, timeout) {
                if (timer) {
                    clearTimeout(timer);
                }
                timer = setTimeout(() => fn(), timeout);
            }

            function saveNow() {
                const json = ExcalidrawLib.serializeAsJSON(excalidrawRef.current.getSceneElements(), excalidrawRef.current.getAppState(), excalidrawRef.current.getFiles(), 'local');
                window.parent.postMessage({
                    type: 'excalidraw-save',
                    params: {
                        name,
                        id,
                        json,
                    },
                }, '*');
            }

            function save() {
                debounce(() => {
                    saveNow()
                }, 500)
            }

            const props = {
                key: 'excalidraw',
                ref: excalidrawRef,
                onChange: () => {
                    save();
                },
                langCode: 'zh-CN',
                initialData: initData,
                UIOptions: {
                    canvasActions: {
                        loadScene: true,
                        theme: true,
                    }
                },
            };
            const children = null;

            return React.createElement(
                React.Fragment,
                null,
                React.createElement(
                    "div", {
                        className: "excalidraw-component",
                    },
                    React.createElement(ExcalidrawLib.Excalidraw, props, [
                        React.createElement(ExcalidrawLib.MainMenu, {
                            key: 'mainmenu'
                        }, [
                            React.createElement(ExcalidrawLib.MainMenu.DefaultItems.ToggleTheme, {
                                key: 'ToggleTheme',
                            }),
                            React.createElement(ExcalidrawLib.MainMenu.DefaultItems.ClearCanvas, {
                                key: 'ClearCanvas'
                            }),
                            React.createElement(ExcalidrawLib.MainMenu.DefaultItems.Help, {
                                key: 'help'
                            }),
                            React.createElement(ExcalidrawLib.MainMenu.Item, {
                                key: 'refresh',
                                icon: React.createElement('svg', null, React.createElement('use', {
                                    'xlinkHref': '#iconHelp'
                                })),
                                onSelect: () => window.location.reload(true),
                            }, '刷新'),
                            React.createElement(ExcalidrawLib.MainMenu.Item, {
                                key: 'fullscreen',
                                icon: React.createElement('svg', null, React.createElement('use', {
                                    'xlinkHref': '#iconHelp'
                                })),
                                onSelect: () => toggleFullscreen(),
                            }, '全屏'),

                            React.createElement(ExcalidrawLib.MainMenu.DefaultItems.ChangeCanvasBackground, {
                                key: 'ChangeCanvasBackground'
                            }),
                        ])
                    ]),
                ),
            );
        };

        function init() {
            if (initialized) {
                return;
            }
            const excalidrawWrapper = document.querySelector('.excalidraw-wrapper')
            const root = ReactDOM.createRoot(excalidrawWrapper);
            root.render(React.createElement(App));
            initialized = true;
        }
    </script>
</body>

</html>